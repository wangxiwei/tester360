
<!DOCTYPE HTML>
<html lang="zh-cn,en" >
    <head>
        <title>TODO_LIST · node-wiki</title>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.1.1">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-disqus/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="APPENDIX.html" />
    
    
    <link rel="prev" href="NODE_RUN.html" />
    

    <!-- tester360.cn Baidu tongji analytics -->
<script>
var _hmt = _hmt || [];
(function() {
var hm = document.createElement("script");
hm.src = "//hm.baidu.com/hm.js?7d789811683659f2ce2723c13b6f88ef";
var s = document.getElementsByTagName("script")[0];
s.parentNode.insertBefore(hm, s);
})();
</script>
</head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
            
                <nav role="navigation">
                


<ul class="summary">
    
    
    
        
        <li>
            <a href="http://www.tester360.cn" target="_blank" class="custom-link">首页</a>
        </li>
    
    

    
    <li class="divider"></li>
    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    README
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="PREFACE.html">
            
                <a href="PREFACE.html">
            
                    
                    PREFACE
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="NODE_INTRODUCE.html">
            
                <a href="NODE_INTRODUCE.html">
            
                    
                    NODE_INTRODUCE
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="NODE_JAVASCRIPT.html">
            
                <a href="NODE_JAVASCRIPT.html">
            
                    
                    NODE_JAVASCRIPT
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="NODE_INSTALL.html">
            
                <a href="NODE_INSTALL.html">
            
                    
                    NODE_INSTALL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="NODE_ES6.html">
            
                <a href="NODE_ES6.html">
            
                    
                    NODE_ES6
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="NODE_BASIC.html">
            
                <a href="NODE_BASIC.html">
            
                    
                    NODE_BASIC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="NODE_NPM.html">
            
                <a href="NODE_NPM.html">
            
                    
                    NODE_NPM
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="NODE_EXPRESS.html">
            
                <a href="NODE_EXPRESS.html">
            
                    
                    NODE_EXPRESS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="NODE_EXPRESS_VIEW.html">
            
                <a href="NODE_EXPRESS_VIEW.html">
            
                    
                    NODE_EXPRESS_VIEW
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="NODE_DATABASE.html">
            
                <a href="NODE_DATABASE.html">
            
                    
                    NODE_DATABASE
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="NODE_TEST.html">
            
                <a href="NODE_TEST.html">
            
                    
                    NODE_TEST
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="NODE_RUN.html">
            
                <a href="NODE_RUN.html">
            
                    
                    NODE_RUN
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.14" data-path="TODO_LIST.html">
            
                <a href="TODO_LIST.html">
            
                    
                    TODO_LIST
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="APPENDIX.html">
            
                <a href="APPENDIX.html">
            
                    
                    APPENDIX
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="LINKS.html">
            
                <a href="LINKS.html">
            
                    
                    LINKS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="BIBLIOGRAPHY.html">
            
                <a href="BIBLIOGRAPHY.html">
            
                    
                    BIBLIOGRAPHY
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >TODO_LIST</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
                                <section class="normal markdown-section">
                                
                                <h1 id="&#x7528;-express-&#x548C;-mongodb-&#x5BEB;&#x4E00;&#x500B;-todo-list&#xFF08;node&#x7248;&#x672C;411">&#x7528; Express &#x548C; MongoDB &#x5BEB;&#x4E00;&#x500B; todo list&#xFF08;node&#x7248;&#x672C;:4.1.1)</h1>
<p>&#x7DF4;&#x7FD2;&#x4E00;&#x7A2E;&#x8A9E;&#x8A00;&#x6216;&#x662F; framework &#x6700;&#x5FEB;&#x7684;&#x5165;&#x9580;&#x65B9;&#x5F0F;&#x5C31;&#x662F;&#x5BEB;&#x4E00;&#x500B; todo list &#x4E86;. &#x4ED6;&#x5305;&#x542B;&#x4E86;&#x57FA;&#x672C;&#x7684; C.R.U.D. ( &#x65B0;&#x589E;, &#x8B80;&#x53D6;, &#x66F4;&#x65B0;, &#x522A;&#x9664; ). &#x9019;&#x7BC7;&#x6587;&#x7AE0;&#x5C07;&#x7528; Node.js &#x88E1;&#x6700;&#x901A;&#x7528;&#x7684; framework Express &#x67B6;&#x69CB; application &#x548C; MongoDB &#x4F86;&#x5132;&#x5B58;&#x8CC7;&#x6599;.</p>
<h1 id="&#x539F;&#x59CB;&#x6A94;">&#x539F;&#x59CB;&#x6A94;</h1>
<p><a href="https://github.com/y2468101216/node-wiki-gitbook/tree/master/src/todo_list" target="_blank">https://github.com/y2468101216/node-wiki-gitbook/tree/master/src/todo_list</a></p>
<h1 id="&#x529F;&#x80FD;">&#x529F;&#x80FD;</h1>
<ul>
<li>&#x4F7F;&#x7528; facebook &#x767B;&#x5165;, &#x7528; session &#x4F86;&#x8FA8;&#x5225;&#x6BCF;&#x4E00;&#x554F;&#x4F7F;&#x7528;&#x8005;</li>
<li>&#x53EF;&#x4EE5;&#x65B0;&#x589E;, &#x8B80;&#x53D6;, &#x66F4;&#x65B0;, &#x522A;&#x9664;&#x5F85;&#x8FA6;&#x4E8B;&#x9805;( todo item )</li>
</ul>
<h1 id="&#x958B;&#x767C;&#x74B0;&#x5883;">&#x958B;&#x767C;&#x74B0;&#x5883;</h1>
<p>&#x958B;&#x767C;&#x74B0;&#x5883;
&#x958B;&#x59CB;&#x4E4B;&#x524D;&#x8ACB;&#x78BA;&#x5B9A;&#x4F60;&#x5DF2;&#x7D93;&#x5B89;&#x88DD;&#x4E86; Node.js, Express &#x548C; MongoDB, &#x5982;&#x679C;&#x6C92;&#x6709;&#x53EF;&#x4EE5;&#x53C3;&#x8003;&#x672C;&#x96FB;&#x5B50;&#x66F8;.</p>
<h1 id="nodejs-&#x5957;&#x4EF6;">Node.js &#x5957;&#x4EF6;</h1>
<p>&#x672C;&#x6B21;&#x6211;&#x5011;&#x5C07;&#x4F7F;&#x7528; Node.js, Express, MongoDB, express-generator, ejs &#x4F86;&#x958B;&#x767C;</p>
<h1 id="&#x6B65;&#x9A5F;">&#x6B65;&#x9A5F;</h1>
<p>&#x7528; Express &#x7684; command line &#x5DE5;&#x5177;&#x5E6B;&#x6211;&#x5011;&#x751F;&#x6210;&#x4E00;&#x500B; project &#x96DB;&#x5F62;
&#x9810;&#x8A2D;&#x7684; template engine &#x662F; jade, &#x5728;&#x9019;&#x88E1;&#x6211;&#x5011;&#x6539;&#x7528;&#x6BD4;&#x8F03;&#x5E73;&#x6613;&#x8FD1;&#x4EBA;&#x7684; ejs.</p>
<pre><code>
$ express todo_list -e --git
</code></pre><p>(&#x53EA;&#x9069;&#x7528; Mac &#x4F7F;&#x7528;&#x8005;)&#x5728;&#x5C08;&#x6848;&#x6839;&#x76EE;&#x9304;&#x4FEE;&#x6539; .gitignore&#xFF0C;&#x5728;&#x6700;&#x5F8C;&#x4E00;&#x884C;&#x52A0;&#x5165;</p>
<pre><code>
#mac style file
.DS_Store
</code></pre><h1 id="welcome-to-express">Welcome to Express</h1>
<p>&#x958B;&#x555F; express server &#x7136;&#x5F8C;&#x6253;&#x958B;&#x700F;&#x89BD;&#x5668;&#x700F;&#x89BD; 127.0.0.1:3000 &#x5C31;&#x6703;&#x770B;&#x5230;&#x6B61;&#x8FCE;&#x9801;&#x9762;.</p>
<pre><code>
$ DEBUG=todo_list npm start
</code></pre><p><img src="img/zh-tw/todo_list/express_test.png" alt=""></p>
<p>Project &#x6A94;&#x6848;&#x7D50;&#x69CB;</p>
<pre><code>
todo_list
|-- bin
|   |-- www
|  
|-- node_modules
|   |-- body-parser //&#x8CA0;&#x8CAC;&#x8655;&#x7406;post&#x50B3;&#x56DE;&#x4F86;&#x7684;&#x8CC7;&#x6599;
|   |-- cookie-parser //&#x8655;&#x7406;cookie
|   |-- debug
|   |-- ejs //view engine
|   |-- express //web server
|   |-- mongodb //db server
|   |-- morgan //&#x7D00;&#x9304;http request log
|   `-- serve-favicon //db server 
|
|-- public
|   |-- images
|   |-- javascripts
|   `-- stylesheets
|       |-- style.css
|
|-- routes
|   `-- index.js
|
|-- views
|   |-- index.ejs
|   `-- error.ejs
|
|-- .gitignore
|
|-- app.js
|
`-- package.json
</code></pre><ul>
<li>bin - &#x908F;&#x8F2F;&#x6A94;</li>
<li>node_modules  - &#x5305;&#x542B;&#x6240;&#x6709; project &#x76F8;&#x95DC;&#x5957;&#x4EF6;.</li>
<li>public - &#x5305;&#x542B;&#x6240;&#x6709;&#x975C;&#x614B;&#x6A94;&#x6848;.</li>
<li>routes - &#x8DEF;&#x7531;&#x6A94;.</li>
<li>views - &#x5305;&#x542B; action views, partials &#x9084;&#x6709; layouts.</li>
<li>app.js - &#x5305;&#x542B;&#x8A2D;&#x5B9A;, middlewares, &#x548C; routes &#x7684;&#x5206;&#x914D;.</li>
<li>package.json - &#x76F8;&#x95DC;&#x5957;&#x4EF6;&#x7684;&#x8A2D;&#x5B9A;&#x6A94;.</li>
</ul>
<h1 id="&#x5B89;&#x88DD;-mongodb">&#x5B89;&#x88DD; mongoDB</h1>
<p>&#x6253;&#x958B; package.json&#xFF0C;&#x5728; dependencies &#x63D2;&#x5165;&#x5169;&#x884C;</p>
<pre><code class="lang-json">
 {
  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;todo_list&quot;</span>,
  <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-string">&quot;0.0.0&quot;</span>,
  <span class="hljs-string">&quot;private&quot;</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">&quot;scripts&quot;</span>: {
    <span class="hljs-string">&quot;start&quot;</span>: <span class="hljs-string">&quot;node ./bin/www&quot;</span>
  },
  <span class="hljs-string">&quot;dependencies&quot;</span>: {
    <span class="hljs-string">&quot;body-parser&quot;</span>: <span class="hljs-string">&quot;~1.13.2&quot;</span>,
    <span class="hljs-string">&quot;cookie-parser&quot;</span>: <span class="hljs-string">&quot;~1.3.5&quot;</span>,
    <span class="hljs-string">&quot;debug&quot;</span>: <span class="hljs-string">&quot;~2.2.0&quot;</span>,
    <span class="hljs-string">&quot;ejs&quot;</span>: <span class="hljs-string">&quot;~2.3.3&quot;</span>,
    <span class="hljs-string">&quot;express&quot;</span>: <span class="hljs-string">&quot;~4.13.1&quot;</span>,
    <span class="hljs-string">&quot;morgan&quot;</span>: <span class="hljs-string">&quot;~1.6.1&quot;</span>,
    <span class="hljs-string">&quot;serve-favicon&quot;</span>: <span class="hljs-string">&quot;~2.3.0&quot;</span>,
    <span class="hljs-string">&quot;mongodb&quot;</span>: <span class="hljs-string">&quot;~2.0.0&quot;</span>
  }
}
</code></pre>
<p>&#x7136;&#x5F8C; npm &#x6703;&#x81EA;&#x52D5;&#x8B80;&#x53D6; package.json</p>
<pre><code>
npm install
</code></pre><p>&#x5C31;&#x6703;&#x5E6B;&#x6211;&#x5011; mongoDB &#x88DD;&#x597D;&#x4E86;</p>
<h1 id="&#x5B89;&#x88DD;&#x6E2C;&#x8A66;&#x5DE5;&#x5177;-mocha">&#x5B89;&#x88DD;&#x6E2C;&#x8A66;&#x5DE5;&#x5177;-mocha</h1>
<p>&#x6211;&#x5011;&#x662F;&#x597D;&#x5B69;&#x5B50;&#xFF0C;&#x6240;&#x4EE5;&#x8981;&#x5BEB; unit test&#xFF0C;&#x8A73;&#x7D30;&#x7684;&#x4ECB;&#x7D39;&#x5728; NODE_TEST &#x88E1;</p>
<pre><code>
$ npm install -g mocha
</code></pre><h1 id="mongodb-crud">MongoDB CRUD</h1>
<p>&#x6211;&#x5011;&#x9700;&#x8981;&#x5148;&#x5BEB; CRUD &#x7684;&#x6E2C;&#x8A66;</p>
<p>&#x65B0;&#x589E;&#x4E00;&#x500B; test &#x76EE;&#x9304;&#x4E26;&#x5EFA;&#x7ACB;&#x4E00;&#x500B; dbCRUDTest.js &#x7684;&#x6A94;&#x6848;&#xFF0C;&#x7A0B;&#x5F0F;&#x78BC;&#x5982;&#x4E0B;:</p>
<pre><code class="lang-javascript">
<span class="hljs-keyword">var</span> dbConnect = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;../bin/dbConnect.js&apos;</span>);
<span class="hljs-keyword">var</span> dbConnectTest = <span class="hljs-keyword">new</span> dbConnect();
<span class="hljs-keyword">var</span> crud = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;../bin/dbCRUD.js&apos;</span>);
<span class="hljs-keyword">var</span> crudTest = <span class="hljs-keyword">new</span> crud();
<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;assert&apos;</span>);

describe(<span class="hljs-string">&apos;dbTest&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    before(<span class="hljs-string">&apos;create Test Collection&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;createTestCollection&apos;</span>);
        dbConnectTest.connect(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">db</span>) </span>{
            db.createCollection(<span class="hljs-string">&apos;event&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
                db.close();
                assert.equal(<span class="hljs-literal">null</span>, err);
                done();
            });
        });
    });

    it(<span class="hljs-string">&apos;connect Should Be Success&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
        dbConnectTest.connect(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">db</span>) </span>{
            db.admin().serverInfo(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
                db.close();
                assert.equal(<span class="hljs-literal">null</span>, err);
                done();
            });
        });
    });

    it(<span class="hljs-string">&apos;insert Should Be Success&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
        dbConnectTest.connect(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">db</span>) </span>{
            crudTest.insert({ userId: <span class="hljs-string">&apos;1234&apos;</span>, event: <span class="hljs-string">&apos;test&apos;</span> }, db, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
                db.close();
                <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
                done();
            });
        });
    });

    it(<span class="hljs-string">&apos;select Should Not Be 0&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
        dbConnectTest.connect(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">db</span>) </span>{
            crudTest.select(<span class="hljs-literal">null</span>, db, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">cursor</span>) </span>{
                cursor.count(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, count</span>) </span>{
                    db.close();
                    assert.equal(<span class="hljs-literal">null</span>, err);
                    assert.notEqual(count, <span class="hljs-number">0</span>);
                    done();
                });

            });
        });
    });

    it(<span class="hljs-string">&apos;update Should Be Success. But Update Nothing&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
        dbConnectTest.connect(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">db</span>) </span>{
            crudTest.update({ _id: <span class="hljs-number">1</span>, event: <span class="hljs-string">&apos;test2&apos;</span>, userId: <span class="hljs-string">&apos;1234&apos;</span> }, db, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
                db.close();
                assert.equal(<span class="hljs-literal">null</span>, err);
                assert.equal(<span class="hljs-number">0</span>,results.modifiedCount)
                done();
            });
        });
    });

    it(<span class="hljs-string">&apos;delete Should Be Success. But Delete Nothing&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
        dbConnectTest.connect(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">db</span>) </span>{
            crudTest.delete({ _id: <span class="hljs-number">1</span>, userId: <span class="hljs-string">&apos;1234&apos;</span> }, db, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
                db.close();
                assert.equal(<span class="hljs-literal">null</span>, err);
                assert.equal(<span class="hljs-number">0</span>,results.deletedCount)
                done();
            });
        });
    });

    after(<span class="hljs-string">&apos;drop Test Collection&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">done</span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;dropTestCollection&apos;</span>);
        dbConnectTest.connect(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">db</span>) </span>{
            db.dropCollection(<span class="hljs-string">&apos;event&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
                db.close();
                assert.equal(<span class="hljs-literal">null</span>, err);
                done();
            });
        });

    });
});
</code></pre>
<p>&#x505A;&#x6E2C;&#x8A66;&#x4E4B;&#x524D;&#x6211;&#x5011;&#x9700;&#x8981;&#x5148;&#x628A; mongodb &#x6253;&#x958B;</p>
<p>&#x5728; Ubuntu &#x4E0A; MongoDB &#x958B;&#x6A5F;&#x5F8C;&#x4FBF;&#x6703;&#x81EA;&#x52D5;&#x958B;&#x555F;. &#x5728; Mac &#x4E0A;&#x4F60;&#x9700;&#x8981;&#x624B;&#x52D5;&#x8F38;&#x5165;&#x4E0B;&#x9762;&#x7684;&#x6307;&#x4EE4;.</p>
<pre><code>
$ mongod
</code></pre><p>&#x5728;bin/&#x4E0B;&#x65B0;&#x589E;&#x4E00;&#x500B;&#x6A94;&#x6848;&#x53EB;&#x505A; dbConnect.js &#x4F86;&#x8A2D;&#x5B9A; MongoDB</p>
<pre><code class="lang-javascript">
<span class="hljs-comment">/**
 * Name:dbConnect.js 
 * Purpose:connect mongodb 
 * Author:Yun 
 * Version:1.0
 * Update:2015-10-15
 */</span>

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> MongoClient = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;mongodb&apos;</span>).MongoClient;<span class="hljs-comment">//mongodb client</span>
    <span class="hljs-keyword">var</span> url = <span class="hljs-string">&apos;mongodb://localhost:27017/todo_list_test&apos;</span>;<span class="hljs-comment">// mongodb://&#x767B;&#x5165;url/db&#x540D;&#x7A31;</span>

    <span class="hljs-keyword">this</span>.connect = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">callback</span>) </span>{
        MongoClient.connect(url, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, db</span>) </span>{
            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-keyword">throw</span> err;
            } <span class="hljs-keyword">else</span> {
                callback(db);
            }
        });
    }    
}
</code></pre>
<p>&#x5728; bin/ &#x4E0B;&#x65B0;&#x589E;&#x4E00;&#x500B;&#x6A94;&#x6848;&#x53EB;&#x505A; dbCRUD.js&#xFF0C;&#x9019;&#x662F;&#x7D66; todo_list &#x8B80;&#x5BEB;&#x8CC7;&#x6599;&#x5EAB;&#x7528;&#x7684;&#x3002;</p>
<pre><code class="lang-javascript">
<span class="hljs-comment">/**
 * Name:dbCRUD.js 
 * Purpose:todo_list CRUD
 * Author:Yun 
 * Version:1.0
 * Update:2015-10-15
 */</span>

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

}
</code></pre>
<p>&#x9032;&#x884C;&#x7B2C;&#x4E00;&#x6B21;&#x6E2C;&#x8A66;&#xFF0C;&#x8ACB;&#x5207;&#x63DB;&#x5230; todo_list &#x76EE;&#x9304;&#x5E95;&#x4E0B;&#xFF0C;&#x57F7;&#x884C;&#x4EE5;&#x4E0B;&#x6307;&#x4EE4;</p>
<pre><code>
$ mocha test/dbCRUDTest.js
</code></pre><p><img src="img/zh-tw/todo_list/dbCRUDTestFirst.png" alt=""></p>
<p>&#x5982;&#x4E0A;&#x5716;&#x6240;&#x793A;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x6CE8;&#x610F;&#x5230;&#x96D6;&#x7136; connect &#x904E;&#x4E86;&#xFF0C;&#x4F46; &#x662F;CRUD &#x6C92;&#x6709;&#x904E;&#xFF0C;&#x56E0;&#x70BA;&#x6211;&#x5011;&#x9084;&#x672A;&#x5B9A;&#x7FA9; dbCRUD.js &#x7684; function&#xFF0C;&#x8B93;&#x6211;&#x5011;&#x628A;&#x6D1E;&#x88DC;&#x8D77;&#x4F86;&#x3002;</p>
<p>&#x4FEE;&#x6539; dbCRUD.js &#x5982;&#x4E0B;</p>
<pre><code class="lang-javascript">
<span class="hljs-comment">/**
 * Name:dbCRUD.js 
 * Purpose:todo_list CRUD
 * Author:Yun 
 * Version:1.0
 * Update:2015-10-15
 */</span>

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">this</span>.select = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">findCondition, db, callback</span>) </span>{
        <span class="hljs-keyword">var</span> cursor = db.collection(<span class="hljs-string">&apos;event&apos;</span>).find(findCondition);
        callback(cursor);
    }

    <span class="hljs-keyword">this</span>.insert = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">insertObject, db, callback</span>) </span>{
        db.collection(<span class="hljs-string">&apos;event&apos;</span>).insertOne({event:insertObject.event, userId:insertObject.userId}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
            callback(err, results);
        });
    }

    <span class="hljs-keyword">this</span>.update = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">updateObject, db, callback</span>) </span>{
        <span class="hljs-keyword">var</span> ObjectID = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;mongodb&apos;</span>).ObjectID
        <span class="hljs-keyword">var</span> id = <span class="hljs-keyword">new</span> ObjectID(updateObject.id);
        db.collection(<span class="hljs-string">&apos;event&apos;</span>).updateOne({_id:id, userId:updateObject.userId}, {$set:{event:updateObject.event}} ,<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
            callback(err, results);
        });
    }

    <span class="hljs-keyword">this</span>.delete = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">deleteObject, db, callback</span>) </span>{
        <span class="hljs-keyword">var</span> ObjectID = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;mongodb&apos;</span>).ObjectID
        <span class="hljs-keyword">var</span> id = <span class="hljs-keyword">new</span> ObjectID(deleteObject.id);
        db.collection(<span class="hljs-string">&apos;event&apos;</span>).deleteOne({_id:id, userId:deleteObject.userId}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
            callback(err, results);
        });
    }
}
</code></pre>
<p>&#x57F7;&#x884C;&#x7B2C;&#x4E8C;&#x6B21;&#x6E2C;&#x8A66;&#x5982;&#x4E0B;</p>
<pre><code>
$ mocha test/dbCRUDTest.js
</code></pre><p><img src="img/zh-tw/todo_list/dbCRUDTestSecond.png" alt=""></p>
<p>&#x9019;&#x6B21;&#x5C31;&#x5168;&#x6578;&#x901A;&#x904E;&#x4E86;&#x3002;</p>
<ul>
<li>&#x5099;&#x8A3B;</li>
</ul>
<p>&#x9019;&#x500B;&#x6E2C;&#x8A66;&#xFF0C;&#x6709;&#x5169;&#x500B;&#x4E0D;&#x597D;&#x7684;&#x5730;&#x65B9;&#x3002;</p>
<ol>
<li>connect &#x8DDF;&#x6240;&#x6709;&#x76F8;&#x4F9D;&#x5728;&#x4E00;&#x8D77;&#x4E86;</li>
<li>insert &#x8DDF; select &#x76F8;&#x4F9D;&#x5728;&#x4E00;&#x8D77;&#x4E86;</li>
</ol>
<p>&#x7406;&#x8AD6;&#x4E0A;&#x61C9;&#x8A72;&#x8981;&#x65B0;&#x589E;&#x4E00;&#x500B;&#x5047;&#x7684; db instance &#x53BB;&#x505A;&#x6E2C;&#x8A66;&#xFF0C;&#x4F46;&#x662F;&#x56E0;&#x70BA;&#x4F5C;&#x8005;&#x61F6;&#x60F0;&#x7684;&#x95DC;&#x4FC2;&#xFF0C;&#x6240;&#x4EE5;&#x6C7A;&#x5B9A;&#x9019;&#x6A23;&#x5BEB;&#x3002;</p>
<h2 id="&#x4FEE;&#x6539;-indexjs-&#x4F7F;&#x4ED6;&#x53EF;&#x4EE5;&#x67E5;&#x8A62;">&#x4FEE;&#x6539; index.js &#x4F7F;&#x4ED6;&#x53EF;&#x4EE5;&#x67E5;&#x8A62;</h2>
<p>&#x6211;&#x5011;&#x9700;&#x8981;&#x8ABF;&#x6574; index.js&#xFF0C;&#x8B93;&#x4ED6;&#x53EF;&#x4EE5;&#x5E36;&#x67E5;&#x8A62;&#x7684;&#x7D50;&#x679C;</p>
<p>index.js &#x4FEE;&#x6539;&#x7A0B;&#x5F0F;&#x78BC;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code class="lang-javascript">
<span class="hljs-comment">/**
 * Name:index.js 
 * Purpose:show index.html
 * Author:Yun 
 * Version:1.0
 * Update:2015-10-20
 */</span>

<span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;express&apos;</span>);
<span class="hljs-keyword">var</span> router = express.Router();

<span class="hljs-keyword">var</span> dbConnect = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;../bin/dbConnect.js&apos;</span>);
<span class="hljs-keyword">var</span> dbConn = <span class="hljs-keyword">new</span> dbConnect();

<span class="hljs-keyword">var</span> dbCRUD = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;../bin/dbCRUD.js&apos;</span>);
<span class="hljs-keyword">var</span> dbCRUDMethod = <span class="hljs-keyword">new</span> dbCRUD();

<span class="hljs-comment">/* GET home page. */</span>
router.get(<span class="hljs-string">&apos;/&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
  dbConn.connect(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">db</span>) </span>{
    dbCRUDMethod.select(<span class="hljs-literal">null</span>, db, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">cursor</span>) </span>{
      <span class="hljs-keyword">var</span> data = [];
      cursor.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">result</span>)</span>{
        data.push(result);
        db.close();
      },<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
        <span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">throw</span> err;
        res.render(<span class="hljs-string">&apos;index&apos;</span>, { title: <span class="hljs-string">&apos;Express&apos;</span>, cursor: data });
      });

    });
  });

});

<span class="hljs-built_in">module</span>.exports = router;
</code></pre>
<p>&#x4FEE;&#x6539; index.ejs &#x5982;&#x4E0B;:</p>
<pre><code class="lang-html">
<span class="hljs-meta">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">title</span> %&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&apos;stylesheet&apos;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&apos;/stylesheets/style.css&apos;</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">title</span> %&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Welcome to <span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">title</span> %&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">%</span> <span class="hljs-attr">cursor.forEach</span>(<span class="hljs-attr">function</span>(<span class="hljs-attr">data</span>){ %&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">data.event</span> %&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">%</span> }); %&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>&#x57F7;&#x884C;:</p>
<pre><code>DEBUG=todo_list npm start
</code></pre><p>&#x9023;<a href="http://localhost:3000/" target="_blank">http://localhost:3000/</a>&#x5373;&#x53EF;&#x770B;&#x5230;&#x6210;&#x679C;</p>
<p><img src="img/zh-tw/todo_list/todo_listTestIndex.png" alt=""></p>
<p>&#x9019;&#x6642;&#x9084;&#x6C92;&#x4EFB;&#x4F55;&#x986F;&#x793A;&#x4EFB;&#x4F55;&#x8CC7;&#x6599;&#xFF0C;&#x56E0;&#x70BA;&#x8CC7;&#x6599;&#x5EAB;&#x88E1;&#x5C1A;&#x672A;&#x5132;&#x5B58;&#x4EFB;&#x4F55;&#x8CC7;&#x6599;&#x3002;</p>
<h1 id="&#x4FEE;&#x6539;todolist&#x4F7F;&#x5176;&#x6709;&#x65B0;&#x589E;&#x529F;&#x80FD;">&#x4FEE;&#x6539;todo_list&#x4F7F;&#x5176;&#x6709;&#x65B0;&#x589E;&#x529F;&#x80FD;</h1>
<pre><code class="lang-html">
<span class="hljs-meta">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">title</span> %&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&apos;stylesheet&apos;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&apos;/stylesheets/style.css&apos;</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Welcome to <span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">title</span> %&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;insert&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;&#x8ACB;&#x8F38;&#x5165;&#x4EE3;&#x8FA6;&#x4E8B;&#x9805;&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span>&#x9001;&#x51FA;<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">%</span> <span class="hljs-attr">cursor.forEach</span>(<span class="hljs-attr">function</span>(<span class="hljs-attr">data</span>){ %&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">data.event</span> %&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">%</span> }); %&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>app.js:</p>
<pre><code class="lang-javascript">
<span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;express&apos;</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;path&apos;</span>);
<span class="hljs-keyword">var</span> favicon = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;serve-favicon&apos;</span>);
<span class="hljs-keyword">var</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;morgan&apos;</span>);
<span class="hljs-keyword">var</span> cookieParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;cookie-parser&apos;</span>);
<span class="hljs-keyword">var</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;body-parser&apos;</span>);

<span class="hljs-keyword">var</span> routes = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;./routes/index&apos;</span>);
<span class="hljs-keyword">var</span> users = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;./routes/users&apos;</span>);

<span class="hljs-keyword">var</span> app = express();

<span class="hljs-comment">// view engine setup</span>
app.set(<span class="hljs-string">&apos;views&apos;</span>, path.join(__dirname, <span class="hljs-string">&apos;views&apos;</span>));
app.set(<span class="hljs-string">&apos;view engine&apos;</span>, <span class="hljs-string">&apos;ejs&apos;</span>);

<span class="hljs-comment">// uncomment after placing your favicon in /public</span>
<span class="hljs-comment">//app.use(favicon(path.join(__dirname, &apos;public&apos;, &apos;favicon.ico&apos;)));</span>
app.use(logger(<span class="hljs-string">&apos;dev&apos;</span>));
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: <span class="hljs-literal">false</span> }));
app.use(cookieParser());
app.use(express.static(path.join(__dirname, <span class="hljs-string">&apos;public&apos;</span>)));

app.use(<span class="hljs-string">&apos;/&apos;</span>, routes);
app.use(<span class="hljs-string">&apos;/users&apos;</span>, users);
app.use(<span class="hljs-string">&apos;/control/:method&apos;</span>, control);

<span class="hljs-comment">// catch 404 and forward to error handler</span>
app.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
  <span class="hljs-keyword">var</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&apos;Not Found&apos;</span>);
  err.status = <span class="hljs-number">404</span>;
  next(err);
});

<span class="hljs-comment">// error handlers</span>

<span class="hljs-comment">// development error handler</span>
<span class="hljs-comment">// will print stacktrace</span>
<span class="hljs-keyword">if</span> (app.get(<span class="hljs-string">&apos;env&apos;</span>) === <span class="hljs-string">&apos;development&apos;</span>) {
  app.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, req, res, next</span>) </span>{
    res.status(err.status || <span class="hljs-number">500</span>);
    res.render(<span class="hljs-string">&apos;error&apos;</span>, {
      message: err.message,
      error: err
    });
  });
}

<span class="hljs-comment">// production error handler</span>
<span class="hljs-comment">// no stacktraces leaked to user</span>
app.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, req, res, next</span>) </span>{
  res.status(err.status || <span class="hljs-number">500</span>);
  res.render(<span class="hljs-string">&apos;error&apos;</span>, {
    message: err.message,
    error: {}
  });
});


<span class="hljs-built_in">module</span>.exports = app;
</code></pre>
<p>&#x65B0;&#x589E;&#x4E00;&#x500B;control.js&#x6A94;&#x6848;&#x5728;routes&#x5E95;&#x4E0B;</p>
<pre><code class="lang-javascript"><span class="hljs-comment">/**
 * Name:control.js 
 * Purpose:update insert delete todo_list
 * Author:Yun 
 * Version:1.0
 * Update:2015-10-21
 */</span>

<span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;express&apos;</span>);
<span class="hljs-keyword">var</span> router = express.Router();

<span class="hljs-comment">/* insert home page. */</span>
router.post(<span class="hljs-string">&apos;/&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
  <span class="hljs-keyword">var</span> Db = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;../bin/DbConnect.js&apos;</span>);
  <span class="hljs-keyword">var</span> dbConn = <span class="hljs-keyword">new</span> Db();
  <span class="hljs-keyword">var</span> dbCRUD = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;../bin/dbCRUD.js&apos;</span>);
  <span class="hljs-keyword">var</span> dbCRUDControl = <span class="hljs-keyword">new</span> dbCRUD();
  dbConn.connect(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">db</span>) </span>{
    <span class="hljs-keyword">switch</span> (req.query.method) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;insert&apos;</span>:
        dbCRUDControl.insert({ event: req.body.event, userId: <span class="hljs-number">1234</span> }, db, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
          <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
          db.close();
          res.redirect(<span class="hljs-string">&apos;/&apos;</span>);
        });
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        res.redirect(<span class="hljs-string">&apos;/&apos;</span>);
        <span class="hljs-keyword">break</span>;
    }
  });
});

<span class="hljs-built_in">module</span>.exports = router;
</code></pre>
<p>&#x57F7;&#x884C;:</p>
<pre><code>DEBUG=todo_list npm start
</code></pre><p>&#x9023; <a href="http://localhost:3000/" target="_blank">http://localhost:3000/</a> &#x5373;&#x53EF;&#x770B;&#x5230;&#x6210;&#x679C;</p>
<p><img src="img/zh-tw/todo_list/todo_listTestShowData.png" alt=""></p>
<h1 id="&#x5B8C;&#x6210;&#x4FEE;&#x6539;&#x3001;&#x522A;&#x9664;&#x529F;&#x80FD;&#x3002;">&#x5B8C;&#x6210;&#x4FEE;&#x6539;&#x3001;&#x522A;&#x9664;&#x529F;&#x80FD;&#x3002;</h1>
<p>index.ejs:</p>
<pre><code class="lang-html">
&lt;!DOCTYPE html&gt;
&lt;html&gt;

&lt;head&gt;
  &lt;title&gt;
    &lt;%= title %&gt;
  &lt;/title&gt;
  &lt;link rel=&apos;stylesheet&apos; href=&apos;/stylesheets/style.css&apos; /&gt;
  &lt;!-- Latest compiled and minified CSS --&gt;
  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css&quot;&gt;

  &lt;!-- Optional theme --&gt;
  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css&quot;&gt;

  &lt;!-- Latest jquery  --&gt;
  &lt;script src=&quot;https://code.jquery.com/jquery-2.1.4.min.js&quot;&gt;&lt;/script&gt;

  &lt;!-- Latest compiled and minified JavaScript --&gt;
  &lt;script src=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;div class=&quot;row&quot;&gt;
    &lt;p&gt;Welcome to
      &lt;%= title %&gt;
    &lt;/p&gt;
  &lt;/div&gt;
  &lt;div class=&quot;row&quot;&gt;
    &lt;form method=&quot;post&quot; action=&quot;control?method=insert&quot; class=&quot;form-inline&quot;&gt;
      &lt;input type=&quot;text&quot; name=&quot;event&quot; value=&quot;&quot; placeholder=&quot;&#x8ACB;&#x8F38;&#x5165;&#x4EE3;&#x8FA6;&#x4E8B;&#x9805;&quot; /&gt;
      &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary&quot; value=&quot;&quot;&gt;&#x9001;&#x51FA;&lt;/button&gt;
    &lt;/form&gt;
  &lt;/div&gt;
  &lt;div class=&quot;row&quot;&gt;
    &lt;table class=&quot;table&quot;&gt;
      &lt;thead&gt;
        &lt;tr&gt;
          &lt;td&gt;&#x5F85;&#x8FA6;&#x4E8B;&#x9805;&lt;/td&gt;
          &lt;td&gt;&#x529F;&#x80FD;&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/thead&gt;
      &lt;tbody
      &lt;% cursor.forEach(function(data){ %&gt;
        &lt;tr&gt;
          &lt;td&gt;
            &lt;%= data.event %&gt;
          &lt;/td&gt;
          &lt;td&gt;
            &lt;button type=&quot;button&quot; class=&quot;btn btn-default&quot; onclick=&quot;showModal(&apos;&lt;%= data.event %&gt;&apos;,&apos;&lt;%= data._id %&gt;&apos;,&apos;update&apos;)&quot;&gt;&#x4FEE;&#x6539;&lt;/button&gt;
            &lt;button type=&quot;button&quot; class=&quot;btn btn-default&quot; onclick=&quot;showModal(&apos;&apos;,&apos;&lt;%= data._id %&gt;&apos;,&apos;delete&apos;)&quot;&gt;&#x522A;&#x9664;&lt;/button&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
        &lt;% }); %&gt;
      &lt;/tbody&gt;
    &lt;/table&gt;
  &lt;/div&gt;

  &lt;!-- modal for update --&gt;
  &lt;div class=&quot;modal fade&quot; id=&quot;updateModal&quot;&gt;
    &lt;div class=&quot;modal-dialog&quot;&gt;
      &lt;div class=&quot;modal-content&quot;&gt;
        &lt;div class=&quot;modal-header&quot;&gt;
          &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot; aria-label=&quot;Close&quot;&gt;&lt;span aria-hidden=&quot;true&quot;&gt;&amp;times;&lt;/span&gt;&lt;/button&gt;
          &lt;h4 class=&quot;modal-title&quot;&gt;&#x4FEE;&#x6539;&#x4EE3;&#x8FA6;&#x4E8B;&#x9805;&lt;/h4&gt;
        &lt;/div&gt;
        &lt;form method=&quot;post&quot; action=&quot;control?method=update&quot;&gt;
          &lt;div class=&quot;modal-body&quot;&gt;
            &lt;input type=&quot;text&quot; value=&quot;&quot; name=&quot;updateImportEventText&quot; id=&quot;updateImportEventText&quot; /&gt;
            &lt;input type=&quot;hidden&quot; value=&quot;&quot; name=&quot;updateImportEventId&quot; id=&quot;updateImportEventId&quot; /&gt;
          &lt;/div&gt;
          &lt;div class=&quot;modal-footer&quot;&gt;
            &lt;button type=&quot;button&quot; class=&quot;btn btn-default&quot; data-dismiss=&quot;modal&quot;&gt;Close&lt;/button&gt;
            &lt;button type=&quot;submit&quot; class=&quot;btn btn-warning&quot;&gt;Save&lt;/button&gt;
          &lt;/div&gt;
        &lt;/form&gt;
      &lt;/div&gt;
      &lt;!-- /.modal-content --&gt;
    &lt;/div&gt;
    &lt;!-- /.modal-dialog --&gt;
  &lt;/div&gt;
  &lt;!-- /.modal --&gt;

  &lt;!-- modal for delete --&gt;
  &lt;div class=&quot;modal fade&quot; id=&quot;deleteModal&quot;&gt;
    &lt;div class=&quot;modal-dialog&quot;&gt;
      &lt;div class=&quot;modal-content&quot;&gt;
        &lt;div class=&quot;modal-header&quot;&gt;
          &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot; aria-label=&quot;Close&quot;&gt;&lt;span aria-hidden=&quot;true&quot;&gt;&amp;times;&lt;/span&gt;&lt;/button&gt;
          &lt;h4 class=&quot;modal-title&quot;&gt;&#x522A;&#x9664;&#x4EE3;&#x8FA6;&#x4E8B;&#x9805;&lt;/h4&gt;
        &lt;/div&gt;
        &lt;form method=&quot;post&quot; action=&quot;control?method=delete&quot;&gt;
          &lt;div class=&quot;modal-body&quot;&gt;
            &lt;label&gt;&#x662F;&#x5426;&#x522A;&#x9664;&lt;/label&gt;
            &lt;input type=&quot;hidden&quot; value=&quot;&quot; name=&quot;deleteImportEventId&quot; id=&quot;deleteImportEventId&quot; /&gt;
          &lt;/div&gt;
          &lt;div class=&quot;modal-footer&quot;&gt;
            &lt;button type=&quot;button&quot; class=&quot;btn btn-default&quot; data-dismiss=&quot;modal&quot;&gt;&#x5426;&lt;/button&gt;
            &lt;button type=&quot;submit&quot; class=&quot;btn btn-warning&quot;&gt;&#x662F;&lt;/button&gt;
          &lt;/div&gt;
        &lt;/form&gt;
      &lt;/div&gt;
      &lt;!-- /.modal-content --&gt;
    &lt;/div&gt;
    &lt;!-- /.modal-dialog --&gt;
  &lt;/div&gt;
  &lt;!-- /.modal --&gt;
&lt;/body&gt;

&lt;script&gt;
  function showModal(event, id, method){
    switch (method){
      case &apos;update&apos;:
      $(&apos;#updateImportEventId&apos;).val(id);
      $(&apos;#updateImportEventText&apos;).val(event);
      $(&apos;#updateModal&apos;).modal(&apos;show&apos;);
      break;
      case &apos;delete&apos;:
      $(&apos;#deleteImportEventId&apos;).val(id);
      $(&apos;#deleteModal&apos;).modal(&apos;show&apos;);
      break;
    }
  }

&lt;/script&gt;

&lt;/html&gt;
</code></pre>
<p>control.js:</p>
<pre><code class="lang-javascript">
<span class="hljs-comment">/**
 * Name:control.js 
 * Purpose:update insert delete todo_list
 * Author:Yun 
 * Version:1.0
 * Update:2015-10-21
 */</span>

<span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;express&apos;</span>);
<span class="hljs-keyword">var</span> router = express.Router();

<span class="hljs-comment">/* insert home page. */</span>
router.post(<span class="hljs-string">&apos;/&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
  <span class="hljs-keyword">var</span> Db = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;../bin/DbConnect.js&apos;</span>);
  <span class="hljs-keyword">var</span> dbConn = <span class="hljs-keyword">new</span> Db();
  <span class="hljs-keyword">var</span> dbCRUD = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;../bin/dbCRUD.js&apos;</span>);
  <span class="hljs-keyword">var</span> dbCRUDControl = <span class="hljs-keyword">new</span> dbCRUD();
  dbConn.connect(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">db</span>) </span>{
    <span class="hljs-keyword">switch</span> (req.query.method) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;insert&apos;</span>:
        dbCRUDControl.insert({ event: req.body.event, userId: <span class="hljs-number">1234</span> }, db, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
          <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
          db.close();
          res.redirect(<span class="hljs-string">&apos;/&apos;</span>);
        });
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;update&apos;</span>:
        dbCRUDControl.update({ event: req.body.updateImportEventText, id: req.body.updateImportEventId, userId: <span class="hljs-number">1234</span> }, db, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
          <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
          db.close();
          res.redirect(<span class="hljs-string">&apos;/&apos;</span>);
        });
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;delete&apos;</span>:
        dbCRUDControl.delete({ id: req.body.deleteImportEventId, userId: <span class="hljs-number">1234</span> }, db, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
          <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
          db.close();
          res.redirect(<span class="hljs-string">&apos;/&apos;</span>);
        });
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        res.redirect(<span class="hljs-string">&apos;/&apos;</span>);
        <span class="hljs-keyword">break</span>;
    }
  });
});

<span class="hljs-built_in">module</span>.exports = router;
</code></pre>
<p>&#x6211;&#x5728; HTML &#x88E1;&#x5F15;&#x5165;&#x4E86; bootstrap &#x8DDF; jquery &#x4EE5;&#x589E;&#x9032;&#x4F7F;&#x7528;&#x8005;&#x9AD4;&#x9A57;&#x8DDF;&#x7F8E;&#x5316;&#x3002;
&#x4E26;&#x4E14;&#x5728; control.js &#x88E1;&#x589E;&#x52A0;&#x4E86; delete &#x8DDF; update &#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x4F60;&#x53EF;&#x4EE5;&#x8A66;&#x8457;&#x904B;&#x884C;&#x770B;&#x770B;&#x7D50;&#x679C;&#x5982;&#x4F55;&#x3002;</p>
<p><img src="img/zh-tw/todo_list/todo_listTestCRUD.png" alt=""></p>
<h1 id="passportjs-&#x5B89;&#x88DD;">passport.js &#x5B89;&#x88DD;</h1>
<p>&#x4F60;&#x53EF;&#x4EE5;&#x6CE8;&#x610F;&#x5230;&#x6211;&#x5011;&#x7684; userid &#x90FD;&#x662F;&#x5BEB;&#x6B7B;&#x7684;&#xFF0C;&#x9019;&#x6A23;&#x7121;&#x6CD5;&#x5340;&#x5225;&#x4F7F;&#x7528;&#x8005;&#xFF0C;&#x6240;&#x4EE5;&#x9019;&#x908A;&#x6211;&#x5011;&#x5C07;&#x904B;&#x7528; passport.js &#x505A; facebook &#x767B;&#x5165;&#x3002;</p>
<p>&#x4FEE;&#x6539; package.json:</p>
<pre><code class="lang-json">
{
  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;todo_list&quot;</span>,
  <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-string">&quot;0.0.0&quot;</span>,
  <span class="hljs-string">&quot;private&quot;</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">&quot;scripts&quot;</span>: {
    <span class="hljs-string">&quot;start&quot;</span>: <span class="hljs-string">&quot;node ./bin/www&quot;</span>
  },
  <span class="hljs-string">&quot;dependencies&quot;</span>: {
    <span class="hljs-string">&quot;body-parser&quot;</span>: <span class="hljs-string">&quot;~1.13.2&quot;</span>,
    <span class="hljs-string">&quot;cookie-parser&quot;</span>: <span class="hljs-string">&quot;~1.3.5&quot;</span>,
    <span class="hljs-string">&quot;debug&quot;</span>: <span class="hljs-string">&quot;~2.2.0&quot;</span>,
    <span class="hljs-string">&quot;ejs&quot;</span>: <span class="hljs-string">&quot;~2.3.3&quot;</span>,
    <span class="hljs-string">&quot;express&quot;</span>: <span class="hljs-string">&quot;~4.13.1&quot;</span>,
    <span class="hljs-string">&quot;morgan&quot;</span>: <span class="hljs-string">&quot;~1.6.1&quot;</span>,
    <span class="hljs-string">&quot;serve-favicon&quot;</span>: <span class="hljs-string">&quot;~2.3.0&quot;</span>,
    <span class="hljs-string">&quot;mongodb&quot;</span>: <span class="hljs-string">&quot;~2.0.0&quot;</span>,
    <span class="hljs-string">&quot;cookie-session&quot;</span>:<span class="hljs-string">&quot;~2.0.0&quot;</span>,
    <span class="hljs-string">&quot;passport&quot;</span>:<span class="hljs-string">&quot;~0.3.0&quot;</span>,
    <span class="hljs-string">&quot;passport-facebook&quot;</span>:<span class="hljs-string">&quot;2.0.0&quot;</span>
  }
}
</code></pre>
<p>passport &#x9700;&#x8981; session &#x5132;&#x5B58;&#x4F7F;&#x7528;&#x8005;&#x8CC7;&#x8A0A;&#xFF0C;&#x9019;&#x88E1;&#x6211;&#x5011;&#x9078;&#x64C7; cookie-session&#xFF0C;&#x9084;&#x9700;&#x8981;&#x64F4;&#x5145;&#x6A21;&#x7D44;&#x4EE5;&#x652F;&#x63F4; facebook &#x767B;&#x5165;</p>
<p>&#x57F7;&#x884C;:</p>
<pre><code>
$ npm install
</code></pre><ul>
<li>facebook APP &#x7533;&#x8ACB;</li>
</ul>
<p>&#x767B;&#x5165; <a href="https://developers.facebook.com" target="_blank">https://developers.facebook.com</a>&#xFF0C;&#x9EDE;&#x9078;&#x4E0A;&#x65B9;&#x9078;&#x55AE;&#x7684; My apps-&gt;Add a New App</p>
<p><img src="img/zh-tw/todo_list/facebookApplyFirstStep.png" alt="">
<img src="img/zh-tw/todo_list/facebookApplySecondStep.png" alt="">
<img src="img/zh-tw/todo_list/facebookApplyThirdStep.png" alt=""></p>
<p>&#x9EDE;&#x9078; Settings&#xFF0C;&#x5207;&#x63DB;&#x5230;&#x4E0A;&#x65B9;&#x7684; Advanced &#x5206;&#x9801;&#x3002;</p>
<p><img src="img/zh-tw/todo_list/facebookApplyForthStep.png" alt=""></p>
<p>&#x5F80;&#x4E0B;&#x5C0B;&#x627E; Valid OAuth redirect URIs&#xFF0C;&#x586B;&#x5BEB;&#x5982;&#x5716;</p>
<p><img src="img/zh-tw/todo_list/facebookApplyFifthStep.png" alt=""></p>
<p>&#x62C9;&#x5230;&#x6700;&#x4E0B;&#x6309; save &#x5C31;&#x5B8C;&#x6210;&#x4E86;&#x3002;</p>
<ul>
<li>&#x9644;&#x8A3B;</li>
</ul>
<p>&#x5982;&#x679C;&#x4F60;&#x60F3;&#x8981;&#x63D0;&#x4F9B;&#x7D66;&#x5176;&#x4ED6;&#x4EBA;&#x767B;&#x5165;&#x7684;&#x8A71;&#x5FC5;&#x9808;&#x5C07;&#x4E0B;&#x5716;&#x7684;&#x96FB;&#x5B50;&#x90F5;&#x4EF6;&#x586B;&#x5BEB;&#x5B8C;&#x7562;&#x5F8C;</p>
<p><img src="img/zh-tw/todo_list/facebookPublicFirstStep.png" alt=""></p>
<p>status &amp; Review &#x4E2D;&#x7684; status &#x9EDE;&#x9078; No &#x4F7F;&#x5176;&#x8B8A;&#x6210; Yes</p>
<p><img src="img/zh-tw/todo_list/facebookPublicSecondStep.png" alt=""></p>
<p>app.js:</p>
<pre><code class="lang-javascript">
<span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;express&apos;</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;path&apos;</span>);
<span class="hljs-keyword">var</span> favicon = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;serve-favicon&apos;</span>);
<span class="hljs-keyword">var</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;morgan&apos;</span>);
<span class="hljs-keyword">var</span> cookieParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;cookie-parser&apos;</span>);
<span class="hljs-keyword">var</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;body-parser&apos;</span>);
<span class="hljs-keyword">var</span> cookieSession = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;cookie-session&apos;</span>);

<span class="hljs-comment">//facebbok login</span>
<span class="hljs-keyword">var</span> passport = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;passport&apos;</span>);
<span class="hljs-keyword">var</span> FacebookStrategy = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;passport-facebook&apos;</span>).Strategy

<span class="hljs-keyword">var</span> FACEBOOK_APP_ID = <span class="hljs-string">&quot;--insert-facebook-app-id-here--&quot;</span>
<span class="hljs-keyword">var</span> FACEBOOK_APP_SECRET = <span class="hljs-string">&quot;--insert-facebook-app-secret-here--&quot;</span>;

<span class="hljs-comment">// Passport session setup.</span>
<span class="hljs-comment">//   To support persistent login sessions, Passport needs to be able to</span>
<span class="hljs-comment">//   serialize users into and deserialize users out of the session.  Typically,</span>
<span class="hljs-comment">//   this will be as simple as storing the user ID when serializing, and finding</span>
<span class="hljs-comment">//   the user by ID when deserializing.  However, since this example does not</span>
<span class="hljs-comment">//   have a database of user records, the complete Facebook profile is serialized</span>
<span class="hljs-comment">//   and deserialized.</span>
passport.serializeUser(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">user, done</span>) </span>{
  done(<span class="hljs-literal">null</span>, user);
});

passport.deserializeUser(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">obj, done</span>) </span>{
  done(<span class="hljs-literal">null</span>, obj);
});


<span class="hljs-comment">// Use the FacebookStrategy within Passport.</span>
<span class="hljs-comment">//   Strategies in Passport require a `verify` function, which accept</span>
<span class="hljs-comment">//   credentials (in this case, an accessToken, refreshToken, and Facebook</span>
<span class="hljs-comment">//   profile), and invoke a callback with a user object.</span>
passport.use(<span class="hljs-keyword">new</span> FacebookStrategy({
  clientID: FACEBOOK_APP_ID,
  clientSecret: FACEBOOK_APP_SECRET,
  callbackURL: <span class="hljs-string">&quot;http://localhost:3000/auth/facebook/callback&quot;</span>
},
  <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">accessToken, refreshToken, profile, done</span>) </span>{
    <span class="hljs-comment">// asynchronous verification, for effect...</span>
    process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

      <span class="hljs-comment">// To keep the example simple, the user&apos;s Facebook profile is returned to</span>
      <span class="hljs-comment">// represent the logged-in user.  In a typical application, you would want</span>
      <span class="hljs-comment">// to associate the Facebook account with a user record in your database,</span>
      <span class="hljs-comment">// and return that user instead.</span>
      <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, profile);
    });
  }
  ));

<span class="hljs-keyword">var</span> routes = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;./routes/index&apos;</span>);
<span class="hljs-keyword">var</span> users = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;./routes/users&apos;</span>);
<span class="hljs-keyword">var</span> control = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;./routes/control&apos;</span>);

<span class="hljs-keyword">var</span> app = express();

<span class="hljs-comment">// view engine setup</span>
app.set(<span class="hljs-string">&apos;views&apos;</span>, path.join(__dirname, <span class="hljs-string">&apos;views&apos;</span>));
app.set(<span class="hljs-string">&apos;view engine&apos;</span>, <span class="hljs-string">&apos;ejs&apos;</span>);

<span class="hljs-comment">// uncomment after placing your favicon in /public</span>
<span class="hljs-comment">//app.use(favicon(path.join(__dirname, &apos;public&apos;, &apos;favicon.ico&apos;)));</span>
app.use(logger(<span class="hljs-string">&apos;dev&apos;</span>));
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: <span class="hljs-literal">false</span> }));
app.use(cookieParser());
app.use(cookieSession({ secret: <span class="hljs-string">&apos;I am your FATHER&apos;</span> }));
app.use(express.static(path.join(__dirname, <span class="hljs-string">&apos;public&apos;</span>)));
app.use(passport.initialize());
app.use(passport.session());


app.use(<span class="hljs-string">&apos;/&apos;</span>, routes);
app.use(<span class="hljs-string">&apos;/users&apos;</span>, users);
app.use(<span class="hljs-string">&apos;/control&apos;</span>, control);

<span class="hljs-comment">// GET /auth/facebook</span>
app.get(<span class="hljs-string">&apos;/auth/facebook&apos;</span>,
  passport.authenticate(<span class="hljs-string">&apos;facebook&apos;</span>),
  <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
    <span class="hljs-comment">// The request will be redirected to Facebook for authentication, so this</span>
    <span class="hljs-comment">// function will not be called.</span>
  });

<span class="hljs-comment">// GET /auth/facebook/callback</span>
app.get(<span class="hljs-string">&apos;/auth/facebook/callback&apos;</span>,
  passport.authenticate(<span class="hljs-string">&apos;facebook&apos;</span>, { failureRedirect: <span class="hljs-string">&apos;/&apos;</span> }),
  <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
    res.redirect(<span class="hljs-string">&apos;/&apos;</span>);
  });

app.get(<span class="hljs-string">&apos;/logout&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
  req.logout();
  res.redirect(<span class="hljs-string">&apos;/&apos;</span>);
});

<span class="hljs-comment">// catch 404 and forward to error handler</span>
app.use(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
  <span class="hljs-keyword">var</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&apos;Not Found&apos;</span>);
  err.status = <span class="hljs-number">404</span>;
  next(err);
});

<span class="hljs-comment">// error handlers</span>

<span class="hljs-comment">// development error handler</span>
<span class="hljs-comment">// will print stacktrace</span>
<span class="hljs-keyword">if</span> (app.get(<span class="hljs-string">&apos;env&apos;</span>) === <span class="hljs-string">&apos;development&apos;</span>) {
  app.use(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, req, res, next</span>) </span>{
    res.status(err.status || <span class="hljs-number">500</span>);
    res.render(<span class="hljs-string">&apos;error&apos;</span>, {
      message: err.message,
      error: err
    });
  });
}

<span class="hljs-comment">// production error handler</span>
<span class="hljs-comment">// no stacktraces leaked to user</span>
app.use(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, req, res, next</span>) </span>{
  res.status(err.status || <span class="hljs-number">500</span>);
  res.render(<span class="hljs-string">&apos;error&apos;</span>, {
    message: err.message,
    error: {}
  });
});

<span class="hljs-built_in">module</span>.exports = app;
</code></pre>
<p>index.ejs</p>
<pre><code class="lang-html">
<span class="hljs-meta">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>
    &#x5F85;&#x8FA6;&#x4E8B;&#x9805;
  <span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&apos;stylesheet&apos;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&apos;/stylesheets/style.css&apos;</span> /&gt;</span>
  <span class="hljs-comment">&lt;!-- Latest compiled and minified CSS --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css&quot;</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- Optional theme --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css&quot;</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- Latest jquery  --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://code.jquery.com/jquery-2.1.4.min.js&quot;</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- Latest compiled and minified JavaScript --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js&quot;</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">%</span> <span class="hljs-attr">if</span> (<span class="hljs-attr">name</span>) { %&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;row&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>Welcome to <span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">name</span> %&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-warning btn-xs&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/logout&quot;</span>&gt;</span>&#x767B;&#x51FA;<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;row&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;control?method=insert&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-inline&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;event&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;&#x8ACB;&#x8F38;&#x5165;&#x5F85;&#x8FA6;&#x4E8B;&#x9805;&quot;</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-default&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span>&#x9001;&#x51FA;<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">%</span> }<span class="hljs-attr">else</span>{ %&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;row&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;LoginMessage&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#x8ACB;&#x5148;&#x767B;&#x5165;FB<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-primary&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/auth/facebook&quot;</span>&gt;</span>
      Facebook Login
      <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">%</span> } %&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;row&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;table&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>&#x5F85;&#x8FA6;&#x4E8B;&#x9805;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>&#x529F;&#x80FD;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">tbody</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">%</span> <span class="hljs-attr">if</span> (<span class="hljs-attr">cursor</span>) { %&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">%</span> <span class="hljs-attr">cursor.forEach</span>(<span class="hljs-attr">function</span>(<span class="hljs-attr">data</span>){ %&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">data.event</span> %&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-default&quot;</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;showModal(&apos;&lt;%= data.event %&gt;&apos;,&apos;&lt;%= data._id %&gt;&apos;,&apos;update&apos;)&quot;</span>&gt;</span>&#x4FEE;&#x6539;<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-default&quot;</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;showModal(&apos;&apos;,&apos;&lt;%= data._id %&gt;&apos;,&apos;delete&apos;)&quot;</span>&gt;</span>&#x522A;&#x9664;<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">%</span> }); %&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">%</span> } %&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">tbody</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- modal for update --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;modal fade&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;updateModal&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;modal-dialog&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;modal-content&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;modal-header&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;close&quot;</span> <span class="hljs-attr">data-dismiss</span>=<span class="hljs-string">&quot;modal&quot;</span> <span class="hljs-attr">aria-label</span>=<span class="hljs-string">&quot;Close&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">aria-hidden</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span>&amp;times;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h4</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;modal-title&quot;</span>&gt;</span>&#x4FEE;&#x6539;&#x4EE3;&#x8FA6;&#x4E8B;&#x9805;<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;control?method=update&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;modal-body&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;updateImportEventText&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;updateImportEventText&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;updateImportEventId&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;updateImportEventId&quot;</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;modal-footer&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-default&quot;</span> <span class="hljs-attr">data-dismiss</span>=<span class="hljs-string">&quot;modal&quot;</span>&gt;</span>Close<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-warning&quot;</span>&gt;</span>Save<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- /.modal-content --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- /.modal-dialog --&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- /.modal --&gt;</span>

  <span class="hljs-comment">&lt;!-- modal for delete --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;modal fade&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;deleteModal&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;modal-dialog&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;modal-content&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;modal-header&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;close&quot;</span> <span class="hljs-attr">data-dismiss</span>=<span class="hljs-string">&quot;modal&quot;</span> <span class="hljs-attr">aria-label</span>=<span class="hljs-string">&quot;Close&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">aria-hidden</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span>&amp;times;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h4</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;modal-title&quot;</span>&gt;</span>&#x522A;&#x9664;&#x4EE3;&#x8FA6;&#x4E8B;&#x9805;<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;control?method=delete&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;modal-body&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>&#x662F;&#x5426;&#x522A;&#x9664;<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;deleteImportEventId&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;deleteImportEventId&quot;</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;modal-footer&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-default&quot;</span> <span class="hljs-attr">data-dismiss</span>=<span class="hljs-string">&quot;modal&quot;</span>&gt;</span>&#x5426;<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-warning&quot;</span>&gt;</span>&#x662F;<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- /.modal-content --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- /.modal-dialog --&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- /.modal --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showModal</span>(<span class="hljs-params">event, id, method</span>)</span>{
    <span class="hljs-keyword">switch</span> (method){
      <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;update&apos;</span>:
      $(<span class="hljs-string">&apos;#updateImportEventId&apos;</span>).val(id);
      $(<span class="hljs-string">&apos;#updateImportEventText&apos;</span>).val(event);
      $(<span class="hljs-string">&apos;#updateModal&apos;</span>).modal(<span class="hljs-string">&apos;show&apos;</span>);
      <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;delete&apos;</span>:
      $(<span class="hljs-string">&apos;#deleteImportEventId&apos;</span>).val(id);
      $(<span class="hljs-string">&apos;#deleteModal&apos;</span>).modal(<span class="hljs-string">&apos;show&apos;</span>);
      <span class="hljs-keyword">break</span>;
    }
  }

</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>index.js</p>
<pre><code class="lang-javascript">
<span class="hljs-comment">/**
 * Name:index.js 
 * Purpose:show index.html
 * Author:Yun 
 * Version:1.0
 * Update:2015-10-20
 */</span>

<span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;express&apos;</span>);
<span class="hljs-keyword">var</span> router = express.Router();

<span class="hljs-keyword">var</span> dbConnect = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;../bin/dbConnect.js&apos;</span>);
<span class="hljs-keyword">var</span> dbConn = <span class="hljs-keyword">new</span> dbConnect();

<span class="hljs-keyword">var</span> dbCRUD = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;../bin/dbCRUD.js&apos;</span>);
<span class="hljs-keyword">var</span> dbCRUDMethod = <span class="hljs-keyword">new</span> dbCRUD();


<span class="hljs-comment">/* GET home page. */</span>
router.get(<span class="hljs-string">&apos;/&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
  dbConn.connect(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">db</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> req.user == <span class="hljs-string">&apos;undefined&apos;</span>) {
      res.render(<span class="hljs-string">&apos;index&apos;</span>, { name: <span class="hljs-literal">false</span>, cursor: <span class="hljs-literal">false</span> });
    } <span class="hljs-keyword">else</span> {
      dbCRUDMethod.select({userId:req.user.id}, db, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">cursor</span>) </span>{
        <span class="hljs-keyword">var</span> data = [];
        cursor.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">result</span>) </span>{
          data.push(result);
          db.close();
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
          <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
          res.render(<span class="hljs-string">&apos;index&apos;</span>, { name: req.user.displayName, cursor: data });

        });

      });
    }

  });

});

<span class="hljs-built_in">module</span>.exports = router;
</code></pre>
<p>control.js</p>
<pre><code class="lang-javascript">
<span class="hljs-comment">/**
 * Name:control.js 
 * Purpose:update insert delete todo_list
 * Author:Yun 
 * Version:1.0
 * Update:2015-10-21
 */</span>

<span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;express&apos;</span>);
<span class="hljs-keyword">var</span> router = express.Router();

<span class="hljs-comment">/* insert home page. */</span>
router.post(<span class="hljs-string">&apos;/&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
  <span class="hljs-keyword">var</span> Db = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;../bin/DbConnect.js&apos;</span>);
  <span class="hljs-keyword">var</span> dbConn = <span class="hljs-keyword">new</span> Db();
  <span class="hljs-keyword">var</span> dbCRUD = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;../bin/dbCRUD.js&apos;</span>);
  <span class="hljs-keyword">var</span> dbCRUDControl = <span class="hljs-keyword">new</span> dbCRUD();
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> req.user != <span class="hljs-string">&apos;undefined&apos;</span>) {
    dbConn.connect(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">db</span>) </span>{
      <span class="hljs-keyword">switch</span> (req.query.method) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;insert&apos;</span>:
          dbCRUDControl.insert({ event: req.body.event, userId: req.user.id }, db, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
            <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
            db.close();
            res.redirect(<span class="hljs-string">&apos;/&apos;</span>);
          });
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;update&apos;</span>:
          dbCRUDControl.update({ event: req.body.updateImportEventText, id: req.body.updateImportEventId, userId: req.user.id }, db, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
            <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
            db.close();
            res.redirect(<span class="hljs-string">&apos;/&apos;</span>);
          });
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;delete&apos;</span>:
          dbCRUDControl.delete({ id: req.body.deleteImportEventId, userId: req.user.id }, db, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
            <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
            db.close();
            res.redirect(<span class="hljs-string">&apos;/&apos;</span>);
          });
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
          res.redirect(<span class="hljs-string">&apos;/&apos;</span>);
          <span class="hljs-keyword">break</span>;
      }
    });
  } <span class="hljs-keyword">else</span> {
    res.redirect(<span class="hljs-string">&apos;/&apos;</span>);
  }
});

<span class="hljs-built_in">module</span>.exports = router;
</code></pre>
<p>&#x6700;&#x5F8C;&#x756B;&#x9762;:</p>
<p><img src="img/zh-tw/todo_list/todo_listFinalIsNotLogin.png" alt="">
<img src="img/zh-tw/todo_list/todo_listFinalIsLogin.png" alt=""></p>
<h1 id="&#x5B8C;&#x6210;">&#x5B8C;&#x6210;</h1>
<p>&#x606D;&#x559C;&#x4F60;&#xFF0C;&#x4F60;&#x5DF2;&#x7D93;&#x8DE8;&#x51FA;&#x4E86; Node.js &#x7684;&#x7B2C;&#x4E00;&#x6B65;&#xFF0C;&#x6B61;&#x8FCE;&#x4F60;&#x52A0;&#x5165; Node.js &#x9019;&#x500B;&#x5927;&#x793E;&#x7FA4;&#x3002;</p>

                                
                                </section>
                            
                        </div>
                    </div>
                
            </div>

            
                
                <a href="NODE_RUN.html" class="navigation navigation-prev " aria-label="Previous page: NODE_RUN">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="APPENDIX.html" class="navigation navigation-next " aria-label="Next page: APPENDIX">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"TODO_LIST","level":"1.14","depth":1,"next":{"title":"APPENDIX","level":"1.15","depth":1,"path":"APPENDIX.md","ref":"APPENDIX.md","articles":[]},"previous":{"title":"NODE_RUN","level":"1.13","depth":1,"path":"NODE_RUN.md","ref":"NODE_RUN.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-search","-sharing","-livereload","-fontsettings","baidu","sitemap","disqus"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"baidu":{"token":"7d789811683659f2ce2723c13b6f88ef"},"sitemap":{"hostname":"http://selenium.tester360.cn/"},"disqus":{"useIdentifier":false,"shortName":"wwwtester360cn"},"highlight":{},"lunr":{"maxIndexSize":1000000},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"node-wiki","language":["zh-cn","en"],"links":{"sidebar":{"首页":"http://www.tester360.cn"}},"gitbook":"*","description":"nodejs 学习入门教程"},"file":{"path":"TODO_LIST.md","mtime":"2016-06-20T01:58:12.783Z","type":"markdown"},"gitbook":{"version":"3.1.1","time":"2016-06-20T02:41:31.307Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-baidu/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-disqus/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    

    </body>
</html>

